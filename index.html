<!-- index.html (mobile-friendly + crea room + link diretti + room dal Google Sheet "Rooms" (status=open) + NO localStorage) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tombola Natalizia</title>

  <style>
    :root{
      --bgA:#ff1e3a;
      --bgB:#c4001a;
      --gold:#ffcc2e;
      --txt:#141414;

      --stroke: rgba(255,255,255,.75);
      --shadow: 0 20px 55px rgba(0,0,0,.18);
      --r: 22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height: 100svh;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(255,255,255,.30) 0%, transparent 55%),
        radial-gradient(700px 520px at 85% 10%, rgba(255,204,46,.45) 0%, transparent 55%),
        radial-gradient(900px 700px at 70% 85%, rgba(255,255,255,.22) 0%, transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB));
      overflow-x:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 18px 0;
    }
    .wrap{
      width: 100%;
      max-width: 980px;
      padding: 0 16px;
      display:flex;
      flex-direction:column;
      gap: 18px;
      align-items:center;
    }
    .hero{
      width:100%;
      position: relative;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(255,255,255,.74));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 22px;
      overflow: hidden;
      text-align: center;
    }
    .orn{
      position:absolute;
      inset:-140px -140px auto auto;
      width:420px;
      height:420px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,204,46,.75), transparent 50%),
        radial-gradient(circle at 65% 45%, rgba(10,143,63,.35), transparent 55%),
        radial-gradient(circle at 35% 75%, rgba(255,30,58,.55), transparent 55%);
      opacity:.85;
      transform: rotate(18deg);
      pointer-events:none;
    }
    h1{
      margin: 10px 0 10px;
      font-size: clamp(30px, 6vw, 52px);
      line-height: 1.05;
      letter-spacing: -0.3px;
    }
    .sub{
      margin: 0 auto 12px;
      max-width: 70ch;
      color: rgba(0,0,0,.72);
      font-size: 15px;
      line-height: 1.5;
    }
    .roomLine{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .pill{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.86);
      padding:8px 12px;
      border-radius:999px;
      font-weight: 1000;
      letter-spacing: .3px;
    }
    .ctaRow{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 14px;
    }
    button.btn, a.btn{
      text-decoration:none;
      padding: 14px 16px;
      border-radius: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content:center;
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
      user-select: none;
      color: #111;
      min-height: 48px;
      min-width: min(420px, 100%);
      width: 100%;
      cursor:pointer;
      background: rgba(255,255,255,.85);
    }
    .btn.gold{ background: linear-gradient(180deg, #ffe17b, #ffcc2e); }
    .btn.red{ background: linear-gradient(180deg, #ff6b7c, #ff1e3a); }

    footer{
      text-align: center;
      font-size: clamp(22px, 4.2vw, 40px);
      font-weight: 900;
      letter-spacing: .3px;
      color: rgba(255,255,255,.96);
      text-shadow: 0 10px 24px rgba(0,0,0,.20);
      padding-bottom: 2px;
    }

    /* Snow */
    .snow{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
    .flake{
      position:absolute; top:-10px;
      width:7px; height:7px; border-radius:50%;
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 16px rgba(255,255,255,.45);
      opacity:.9;
      animation: fall linear infinite;
    }
    .flake.gold{
      background: rgba(255,204,46,.95);
      box-shadow: 0 0 16px rgba(255,204,46,.45);
      opacity:.85;
    }
    @keyframes fall{ to{ transform: translate3d(var(--dx), 110svh, 0); } }
    @media (prefers-reduced-motion: reduce){ .flake{ animation:none; opacity:.35; } }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="wrap">
    <div class="hero">
      <div class="orn"></div>

      <h1>ðŸŽ„ Tombola Natalizia â€¢ Max ðŸŽ„</h1>
      <p class="sub">
        Crea una nuova Room e poi apri Tabellone o Cartelle: entrerai direttamente nella room generata.
      </p>

      <div class="roomLine">
        <span class="pill">Room: <span id="roomBadge">â€”</span></span>
      </div>

      <div class="ctaRow">
        <button class="btn red" id="newRoom">âž• Crea nuova Room</button>
        <a class="btn gold" id="goTab" href="./tabellone.html">Apri Tabellone (Conduttore)</a>
        <a class="btn gold" id="goCards" href="./cartelle.html">Apri Cartelle (Giocatori)</a>

        <!-- âœ… rinominato: elimina TUTTE le room -->
        <button class="btn gold" id="purgeAll">ðŸ§¹ Elimina tutte le Rooms</button>
      </div>
    </div>

    <footer>âœ¨ Buone feste e buona tombola! âœ¨</footer>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyM0N-kMkCqD54L-LRCdjALMBry5i1wsdKlpWI8AezXIdQoS53Jp6K6Jguv9MgEbigA/exec";

    function jsonp(action, params={}){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const qs = new URLSearchParams({ action, ...params, callback: cb }).toString();
        const s = document.createElement("script");
        const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout")); }, 12000);

        function cleanup(){
          clearTimeout(t);
          if(window[cb]) delete window[cb];
          if(s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.src = API_BASE + "?" + qs;
        s.onerror = ()=>{ cleanup(); reject(new Error("Network error")); };
        document.body.appendChild(s);
      });
    }

    // âœ… Room corrente SOLO da backend (Rooms.status = "open")
    let currentRoomId = null;

    function setRoom(roomId){
      currentRoomId = (roomId || "").trim().toUpperCase() || null;

      document.getElementById("roomBadge").textContent = currentRoomId || "â€”";

      const goTab = document.getElementById("goTab");
      const goCards = document.getElementById("goCards");

      if(currentRoomId){
        goTab.href   = "./tabellone.html?room=" + encodeURIComponent(currentRoomId);
        goCards.href = "./cartelle.html?room=" + encodeURIComponent(currentRoomId);
      }else{
        // nessuna room open: lasciamo link â€œbaseâ€ senza room
        goTab.href = "./tabellone.html";
        goCards.href = "./cartelle.html";
      }
    }

    async function loadOpenRoom(){
      // richiede Apps Script: action=getOpenRoom => {ok:true, roomId:<string|null>}
      const res = await jsonp("getOpenRoom");
      if(res && res.ok && res.roomId){
        setRoom(res.roomId);
      }else{
        setRoom(null);
      }
    }

    // âœ… BOOT: preleva room open
    (async ()=>{
      try{
        await loadOpenRoom();
      }catch(e){
        setRoom(null);
        alert("Errore nel recupero room dal server: " + String(e));
      }
    })();

    document.getElementById("newRoom").onclick = async ()=>{
      const res = await jsonp("createRoom");
      if(res && res.ok){
        setRoom(res.roomId);
        alert("Room creata: " + res.roomId);
      }else{
        alert("Errore creazione room");
      }
    };

    // âœ… nuovo: elimina TUTTE le rooms dal foglio
    document.getElementById("purgeAll").onclick = async ()=>{
      const msg =
        "ATTENZIONE: questa operazione eliminerÃ  TUTTE le Rooms dal Google Sheet (tabella Rooms).\n\n" +
        "Vuoi davvero procedere?";
      if(!confirm(msg)) return;

      // opzionale: doppia conferma per evitare click accidentali
      if(!confirm("Conferma finale: elimino davvero TUTTE le Rooms?")) return;

      try{
        const res = await jsonp("purgeAllRooms");
        if(res && res.ok){
          alert("Fatto âœ… (tutte le Rooms eliminate)");
          setRoom(null);
          // ricarico lo stato dal server (per sicurezza)
          try{ await loadOpenRoom(); }catch(e){}
        }else{
          alert("Errore: purgeAllRooms non riuscito");
        }
      }catch(e){
        alert("Errore rete/server: " + String(e));
      }
    };

    // Snow
    const snow = document.getElementById('snow');
    const N = 42;
    for (let i = 0; i < N; i++) {
      const f = document.createElement('div');
      const isGold = Math.random() < 0.22;
      f.className = 'flake' + (isGold ? ' gold' : '');
      const x = Math.random() * 100;
      const size = 4 + Math.random() * 6;
      const dur = 8 + Math.random() * 14;
      const dx = (Math.random() * 2 - 1) * 160 + "px";
      f.style.left = x + "vw";
      f.style.width = size + "px";
      f.style.height = size + "px";
      f.style.animationDuration = dur + "s";
      f.style.setProperty('--dx', dx);
      f.style.opacity = (0.35 + Math.random() * 0.6).toFixed(2);
      f.style.filter = `blur(${(Math.random() * 0.6).toFixed(2)}px)`;
      f.style.animationDelay = (-Math.random() * dur) + "s";
      snow.appendChild(f);
    }
  </script>
</body>
</html>
