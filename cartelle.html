<!-- cartelle.html (MOBILE-FIRST + Google Sheet backend + icona Utente) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cartelle ‚Äì Tombola Natalizia</title>

  <style>
    :root{
      --bgA:#ff1e3a;
      --bgB:#c4001a;
      --gold:#ffcc2e;

      --txt:#141414;
      --stroke: rgba(255,255,255,.78);
      --shadow: 0 18px 40px rgba(0,0,0,.14);
      --r: 18px;

      /* top bar */
      --barH: 64px;

      /* sizing (calcolato da JS per essere "il pi√π grande possibile") */
      --cardPad: 5px;
      --gridGap: 1px;
      --cellH: 34px;
      --titleF: 12px;
      --santaF: 22px;

      /* font numeri (clamp controllato da JS) */
      --numMin: 16px;
      --numVw: 6.2vw;
      --numMax: 26px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height: 100svh;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 700px at 10% 10%, rgba(255,255,255,.30) 0%, transparent 58%),
        radial-gradient(800px 600px at 90% 12%, rgba(255,204,46,.35) 0%, transparent 55%),
        radial-gradient(900px 700px at 70% 90%, rgba(255,255,255,.22) 0%, transparent 62%),
        linear-gradient(135deg, var(--bgA), var(--bgB));
      overflow-x:hidden;
    }

    /* Barra fissa (a scomparsa) */
    .topbar{
      position: fixed;
      left: 0; right: 0; top: 0;
      height: var(--barH);
      padding: calc(env(safe-area-inset-top) + 8px) 12px 10px;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      z-index: 50;
      transition: transform .22s ease;
      transform: translateY(0);
    }
    .topbar.hidden{ transform: translateY(-120%); }

    .topbarInner{
      width: min(640px, 100%);
      border: 1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.88);
      border-radius: 999px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      padding: 8px;
      display:flex;
      gap: 10px;
      justify-content: center;
      align-items:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .qtyBtn{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.94);
      color:#111;
      border-radius: 999px;
      padding: 10px 14px;
      min-width: 54px;
      font-weight: 1000;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .qtyBtn.active{
      background: linear-gradient(180deg, #ffe17b, #ffcc2e);
      border-color: rgba(0,0,0,.18);
    }

    /* Bottone Utente */
    .userBtn{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.94);
      color:#111;
      border-radius: 999px;
      padding: 10px 12px;
      min-width: 54px;
      font-weight: 1000;
      font-size: 18px;
      line-height: 1;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .userMini{
      font-size: 12px;
      color: rgba(0,0,0,.60);
      font-weight: 900;
      max-width: 130px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* layout principale */
    .wrap{
      width: 100%;
      padding: calc(var(--barH) + env(safe-area-inset-top) + 10px) 10px 18px;
      display:flex;
      justify-content:center;
    }

    /* UNA SOTTO L'ALTRA */
    .cards{
      width: min(980px, 100%);
      display:grid;
      gap: 10px;
      grid-template-columns: 1fr;
      align-items: start;
    }

    .tcard{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.90);
      border-radius: var(--r);
      padding: var(--cardPad);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    /* Titolo: testo centrato, albero a destra, allineati */
    .tTitle{
      margin: 0 0 3px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      font-size: var(--titleF);
      font-weight: 1000;
      color:#111;
    }
    .tTitleText{ justify-self:center; }
    .tSanta{
      justify-self:end;
      font-size: var(--santaF);
      line-height: 1;
      color: rgba(0,0,0,.55);
    }
    .tSpacer{ display:block; }

    .grid9{
      display:grid;
      grid-template-columns: repeat(9, 1fr);
      gap: var(--gridGap);
    }

    .cell{
      height: var(--cellH);
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.96);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      user-select:none;
      position:relative;
      cursor:pointer;
      color:#0b0b0b;
      font-size: clamp(var(--numMin), var(--numVw), var(--numMax));
      letter-spacing: .2px;
      box-shadow: 0 8px 18px rgba(0,0,0,.07);
    }

    .cell.empty{
      background: rgba(255,255,255,.72);
      cursor:default;
      border-color: rgba(0,0,0,.06);
      box-shadow:none;
    }

    .cell.marked{
      background: linear-gradient(180deg, rgba(215,0,27,.30), rgba(215,0,27,.14));
      border-color: rgba(215,0,27,.62);
      box-shadow: 0 12px 26px rgba(215,0,27,.14);
    }
    .cell.marked::after{ content:""; }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      z-index: 80;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      max-width: min(640px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{ opacity: 1; }

    /* Modal nome */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 90;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      box-shadow: 0 20px 55px rgba(0,0,0,.25);
      padding: 16px;
    }
    .modal h3{ margin:0 0 10px; }
    .modal p{ margin:0 0 10px; color:rgba(0,0,0,.70); }
    .row{
      display:flex; gap:10px; align-items:center;
    }
    input{
      flex:1;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      padding: 12px 12px;
      font-weight: 900;
      outline:none;
    }
    .mBtn{
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.12);
      padding: 12px 12px;
      font-weight: 1000;
      cursor:pointer;
      background: rgba(255,255,255,.92);
      box-shadow: 0 14px 30px rgba(0,0,0,.14);
      min-width: 120px;
    }
    .mBtn.primary{
      background: linear-gradient(180deg, #ffe17b, #ffcc2e);
    }

    /* Glitter snow (leggero) */
    .snow{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
    .flake{
      position:absolute; top:-10px;
      width:6px; height:6px; border-radius:50%;
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 14px rgba(255,255,255,.45);
      opacity:.85;
      animation: fall linear infinite;
    }
    .flake.gold{
      background: rgba(255,204,46,.95);
      box-shadow: 0 0 14px rgba(255,204,46,.45);
      opacity:.8;
    }
    @keyframes fall{ to{ transform: translate3d(var(--dx), 110svh, 0); } }

    @media (prefers-reduced-motion: reduce){
      .flake{ animation:none; opacity:.30; }
      .topbar{ transition: none; }
    }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="toast" id="toast"></div>

  <!-- Modal nome -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Nome giocatore">
    <div class="modal">
      <h3>üë§ Nome giocatore</h3>
      <p>Inserisci il tuo nome (opzionale). Se lasci vuoto, resta un nome univoco automatico.</p>
      <div class="row">
        <input id="nameInput" placeholder="Es. Mario" />
        <button class="mBtn primary" id="saveName">Salva</button>
      </div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end">
        <button class="mBtn" id="closeModal">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Barra top a scomparsa -->
  <div class="topbar" id="topbar">
    <div class="topbarInner" aria-label="Numero cartelle">
      <div id="qtyRow" style="display:flex;gap:10px;align-items:center">
        <button class="qtyBtn" data-n="1">1</button>
        <button class="qtyBtn" data-n="2">2</button>
        <button class="qtyBtn" data-n="3">3</button>
        <button class="qtyBtn active" data-n="4">4</button>
      </div>

      <button class="userBtn" id="userBtn" title="Imposta nome">
        üë§ <span class="userMini" id="userMini">Anonimo</span>
      </button>
    </div>
  </div>

  <div class="wrap">
    <div class="cards" id="cards"></div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbyM0N-kMkCqD54L-LRCdjALMBry5i1wsdKlpWI8AezXIdQoS53Jp6K6Jguv9MgEbigA/exec";

    function getRoomId(){
      const url = new URL(location.href);
      const q = (url.searchParams.get("room") || "").trim().toUpperCase();
      const ls = (localStorage.getItem("tombola_roomId") || "").trim().toUpperCase();
      let room = q || ls;
      if(!room){
        room = (prompt("Inserisci il codice ROOM (es. R636SQ):") || "").trim().toUpperCase();
      }
      if(room) localStorage.setItem("tombola_roomId", room);
      return room;
    }

    // JSONP helper (evita CORS)
    function jsonp(action, params={}){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const qs = new URLSearchParams({ action, ...params, callback: cb }).toString();
        const s = document.createElement("script");
        const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout")); }, 12000);

        function cleanup(){
          clearTimeout(t);
          if(window[cb]) delete window[cb];
          if(s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.src = API_BASE + "?" + qs;
        s.onerror = ()=>{ cleanup(); reject(new Error("Network error")); };
        document.body.appendChild(s);
      });
    }

    // Toast
    const toast = document.getElementById("toast");
    let toastT = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=>toast.classList.remove("show"), 1800);
    }

    // Modal nome
    const overlay = document.getElementById("overlay");
    const userBtn = document.getElementById("userBtn");
    const userMini = document.getElementById("userMini");
    const nameInput = document.getElementById("nameInput");

    function openModal(){
      overlay.classList.add("show");
      nameInput.value = (localStorage.getItem(nameKey()) || "").trim();
      setTimeout(()=>nameInput.focus(), 50);
    }
    function closeModal(){
      overlay.classList.remove("show");
    }

    document.getElementById("closeModal").onclick = closeModal;
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });
    userBtn.onclick = openModal;

    // ====== Identit√† ======
    const roomId = getRoomId();

    function pidKey(){ return "tombola_playerId_" + roomId; }
    function nameKey(){ return "tombola_playerName_" + roomId; }

    function getPlayerId(){
      let pid = (localStorage.getItem(pidKey()) || "").trim().toUpperCase();
      if(!pid){
        pid = Math.random().toString(16).slice(2,10).toUpperCase();
        localStorage.setItem(pidKey(), pid);
      }
      return pid;
    }

    function getPlayerName(){
      return (localStorage.getItem(nameKey()) || "").trim();
    }

    async function join(){
      const playerId = getPlayerId();
      const name = getPlayerName();
      const res = await jsonp("join", { roomId, playerId, name });
      if(res && res.ok){
        // se non avevo nome, prendo quello default univoco dal server
        if(!getPlayerName()){
          localStorage.setItem(nameKey(), res.name || "");
        }
        userMini.textContent = (localStorage.getItem(nameKey()) || "Anonimo");
        return res;
      }
      throw new Error(res && res.error ? res.error : "join failed");
    }

    document.getElementById("saveName").onclick = async ()=>{
      const val = nameInput.value.trim();
      localStorage.setItem(nameKey(), val); // pu√≤ essere vuoto (server user√† default univoco)
      userMini.textContent = (val || "Anonimo");
      closeModal();
      try{
        await jsonp("join", { roomId, playerId: getPlayerId(), name: val });
        showToast("Nome aggiornato ‚úÖ");
      }catch(e){
        showToast("Errore nome ‚ùå");
      }
    };

    // --- Snow (leggero) ---
    const snow = document.getElementById('snow');
    const N = 28;
    for(let i=0;i<N;i++){
      const f = document.createElement('div');
      const isGold = Math.random() < 0.20;
      f.className = 'flake' + (isGold ? ' gold' : '');
      const x = Math.random()*100;
      const size = 3 + Math.random()*5;
      const dur = 9 + Math.random()*14;
      const dx = (Math.random()*2-1) * 140 + "px";
      f.style.left = x + "vw";
      f.style.width = size + "px";
      f.style.height = size + "px";
      f.style.animationDuration = dur + "s";
      f.style.setProperty('--dx', dx);
      f.style.opacity = (0.30 + Math.random()*0.55).toFixed(2);
      f.style.filter = `blur(${(Math.random()*0.6).toFixed(2)}px)`;
      f.style.animationDelay = (-Math.random()*dur) + "s";
      snow.appendChild(f);
    }

    // --- RNG semplice ---
    function rng(){ return Math.random(); }
    function pickUnique(arr, k){
      const a = arr.slice();
      const out = [];
      for(let i=0;i<k;i++){
        const idx = Math.floor(rng()*a.length);
        out.push(a.splice(idx,1)[0]);
      }
      return out;
    }

    const COLS = [
      {min:1,max:9},{min:10,max:19},{min:20,max:29},{min:30,max:39},{min:40,max:49},
      {min:50,max:59},{min:60,max:69},{min:70,max:79},{min:80,max:90},
    ];

    function makeCard(){
      let counts = Array(9).fill(1);
      let remaining = 6;
      while(remaining > 0){
        const c = Math.floor(rng()*9);
        if(counts[c] < 3){ counts[c]++; remaining--; }
      }

      const colNums = counts.map((cnt, ci)=>{
        const range = [];
        for(let n=COLS[ci].min; n<=COLS[ci].max; n++) range.push(n);
        return pickUnique(range, cnt).sort((a,b)=>a-b);
      });

      for(let attempt=0; attempt<250; attempt++){
        const rowCounts = [0,0,0];
        const placement = Array(9).fill(null).map(()=>[]);

        for(let ci=0; ci<9; ci++){
          const cnt = colNums[ci].length;
          let rows;
          if(cnt === 3) rows = [0,1,2];
          else if(cnt === 2){
            const order = [0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b] || (rng()-0.5));
            rows = [order[0], order[1]];
          } else {
            const order = [0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b] || (rng()-0.5));
            rows = [order[0]];
          }
          for(const r of rows){
            placement[ci].push(r);
            rowCounts[r]++;
          }
        }

        if(rowCounts[0]===5 && rowCounts[1]===5 && rowCounts[2]===5){
          const grid = Array.from({length:3}, ()=>Array(9).fill(null));
          for(let ci=0; ci<9; ci++){
            const rows = placement[ci].slice().sort((a,b)=>a-b);
            const nums = colNums[ci];
            for(let i=0;i<rows.length;i++){
              grid[rows[i]][ci] = nums[i];
            }
          }
          return grid;
        }
      }
      return makeCard();
    }

    function renderCard(container, idx, grid){
      const card = document.createElement('div');
      card.className = "tcard";
      card.innerHTML = `
        <h3 class="tTitle">
          <span class="tSpacer"></span>
          <span class="tTitleText">Cartella ${idx+1}</span>
          <span class="tSanta">üéÑ</span>
        </h3>
      `;

      const g = document.createElement('div');
      g.className = 'grid9';

      grid.flat().forEach((val)=>{
        const c = document.createElement('div');
        c.className = 'cell' + (val==null ? ' empty' : '');
        c.textContent = val==null ? '' : val;

        if(val!=null){
          c.addEventListener('click', async ()=>{
            const willMark = !c.classList.contains("marked");
            c.classList.toggle('marked');

            const res = await jsonp("mark", {
              roomId,
              playerId: getPlayerId(),
              cardIndex: idx,
              n: Number(val),
              marked: willMark ? 1 : 0
            });

            if(!res || !res.ok){
              // rollback se server rifiuta (anti-cheat)
              c.classList.toggle('marked');
              showToast(res && res.error ? res.error : "Marcatura rifiutata");
              return;
            }

            // premi nuovi
            if(Array.isArray(res.newly) && res.newly.length){
              showToast("üéâ " + res.newly.map(x=>x.prize).join(", "));
            }
          }, {passive:true});
        }

        g.appendChild(c);
      });

      card.appendChild(g);
      container.appendChild(card);
    }

    // --- Dimensioni "massime possibili" cercando di far stare N cartelle in verticale ---
    const root = document.documentElement;
    const cardsWrap = document.getElementById('cards');
    const topbar = document.getElementById('topbar');

    function applyMaxSizingForN(n){
      const barH = topbar.getBoundingClientRect().height || 64;

      const vh = window.innerHeight;
      const vw = Math.min(window.innerWidth, cardsWrap.getBoundingClientRect().width || window.innerWidth);

      const wrapPadX = 10 * 2;
      const usableW = Math.max(260, vw - wrapPadX);

      const outerGap = 10;
      const wrapPadTop = 10;
      const wrapPadBottom = 18;
      const usableH = vh - barH - wrapPadTop - wrapPadBottom - 12;

      const gap = 1;
      const pad = 5;

      const titleF = 12;
      const titleH = Math.ceil(titleF * 1.2) + 3;

      const cellByW = Math.floor((usableW - (gap * 8) - 2) / 9);
      let cellH = Math.max(18, Math.min(60, cellByW));

      const maxCardH = Math.floor((usableH - outerGap * (n - 1)) / n);
      const maxGridH = maxCardH - (pad * 2) - titleH;
      const maxCellByH = Math.floor((maxGridH - (gap * 2)) / 3);

      if (Number.isFinite(maxCellByH) && maxCellByH > 0) {
        cellH = Math.min(cellH, Math.max(16, maxCellByH));
      }

      const numMax = Math.max(16, Math.min(42, Math.round(cellH * 0.90)));
      const numMin = Math.max(14, Math.round(numMax * 0.82));

      root.style.setProperty('--gridGap', gap + 'px');
      root.style.setProperty('--cellH', cellH + 'px');
      root.style.setProperty('--cardPad', pad + 'px');
      root.style.setProperty('--titleF', titleF + 'px');
      root.style.setProperty('--santaF', Math.round(titleF * 1.8) + 'px');

      root.style.setProperty('--numMin', numMin + 'px');
      root.style.setProperty('--numMax', numMax + 'px');
      root.style.setProperty('--numVw', '6.2vw');
    }

    // --- Numero cartelle: default 4 ---
    let selectedN = 4;
    let currentGrids = [];

    async function registerAllCards(){
      // salva su backend tutte le cartelle del player (serve per anti-cheat)
      const payload = currentGrids.map((grid, i)=>({ cardIndex: i, grid }));
      const res = await jsonp("registerCards", {
        roomId,
        playerId: getPlayerId(),
        cardsJson: JSON.stringify(payload)
      });
      if(!res || !res.ok){
        showToast("Errore salvataggio cartelle");
      }
    }

    async function generate(){
      applyMaxSizingForN(selectedN);

      cardsWrap.innerHTML = "";
      currentGrids = [];
      for(let i=0;i<selectedN;i++){
        const g = makeCard();
        currentGrids.push(g);
        renderCard(cardsWrap, i, g);
      }

      // registra cartelle dopo join
      try{
        await join();
        await registerAllCards();
      }catch(e){
        showToast("Backend non raggiungibile");
      }
    }

    // Click bottoni 1-4
    const qtyRow = document.getElementById('qtyRow');
    qtyRow.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-n]');
      if(!btn) return;

      selectedN = parseInt(btn.dataset.n, 10);
      qtyRow.querySelectorAll('.qtyBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      generate();
    });

    // Barra a scomparsa
    let lastY = window.scrollY;
    let barHidden = false;

    function setBarHidden(hidden){
      barHidden = hidden;
      topbar.classList.toggle('hidden', hidden);
    }

    window.addEventListener('scroll', ()=>{
      const y = window.scrollY;
      const dy = y - lastY;
      lastY = y;

      if(y < 10){ setBarHidden(false); return; }
      if(dy > 6 && !barHidden) setBarHidden(true);
      if(dy < -6 && barHidden) setBarHidden(false);
    }, {passive:true});

    window.addEventListener('touchstart', (e)=>{
      const t = e.touches && e.touches[0];
      if(!t) return;
      if(t.clientY < 80) setBarHidden(false);
    }, {passive:true});

    window.addEventListener('resize', ()=>{
      applyMaxSizingForN(selectedN);
    }, {passive:true});

    // init
    (async ()=>{
      try{
        await join();
        userMini.textContent = (localStorage.getItem(nameKey()) || "Anonimo");
      }catch(e){
        // ok
      }
      applyMaxSizingForN(selectedN);
      generate();
    })();
  </script>
</body>
</html>
